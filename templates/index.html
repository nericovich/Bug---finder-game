<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–æ–¥-–†–µ–≤—å—é —Å –ò–ò</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>

    <div class="container">
        <h1>–ö–æ–¥-–†–µ–≤—å—é —Å –ò–ò ü§ñ</h1>
        
        <div class="task-box">
            <h2 id="task-title">–ì–µ–Ω–µ—Ä–∏—Ä—É—é –∑–∞–¥–∞—á—É...</h2>
            <p id="task-description"></p>
        </div>

        <div class="code-editor">
            <textarea id="code-area" rows="15" placeholder="–ò—Å–ø—Ä–∞–≤—å—Ç–µ –∫–æ–¥ –∑–¥–µ—Å—å..."></textarea>
        </div>

        <div class="controls">
            <button id="check-btn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ —Ä–µ–≤—å—é</button>
            <button id="new-task-btn">–°–ª–µ–¥—É—é—â–µ–µ –∑–∞–¥–∞–Ω–∏–µ</button>
        </div>

        <div id="feedback" class="feedback-box"></div>
    </div>

    <script>
        const taskTitle = document.getElementById('task-title');
        const taskDescription = document.getElementById('task-description');
        const codeArea = document.getElementById('code-area');
        const checkBtn = document.getElementById('check-btn');
        const newTaskBtn = document.getElementById('new-task-btn');
        const feedback = document.getElementById('feedback');

        let currentTask = {};

        async function fetchNewTask() {
            feedback.innerHTML = '';
            feedback.className = 'feedback-box';
            taskTitle.textContent = 'üß† –ì–µ–Ω–µ—Ä–∏—Ä—É—é –Ω–æ–≤—É—é –∑–∞–¥–∞—á—É...';
            taskDescription.textContent = '';
            codeArea.value = '';
            checkBtn.disabled = true;
            newTaskBtn.disabled = true;

            try {
                const response = await fetch('/get-task', { cache: 'no-cache' }); 
                if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∑–∞–¥–∞—á–∏.');
                
                const task = await response.json();
                if (task.error) throw new Error(task.error);

                currentTask = task;

                taskTitle.textContent = task.title;
                taskDescription.textContent = task.task;
                codeArea.value = task.buggy_code;
                
            } catch (error) {
                taskTitle.textContent = '–û—à–∏–±–∫–∞!';
                taskDescription.textContent = `–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∑–∞–¥–∞—á—É. ${error.message}`;
            } finally {
                checkBtn.disabled = false;
                newTaskBtn.disabled = false;
            }
        }

        async function checkSolution() {
            if (!currentTask.task) return;

            const userCode = codeArea.value;
            feedback.className = 'feedback-box';
            feedback.textContent = '–û—Ç–ø—Ä–∞–≤–∏–ª –≤–∞—à –∫–æ–¥ –Ω–∞ —Ä–µ–≤—å—é –∫ –ò–ò...';
            checkBtn.disabled = true;
            newTaskBtn.disabled = true;

            try {
                const response = await fetch('/check-solution-with-llm', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        code: userCode,
                        task: currentTask.task
                    })
                });

                const result = await response.json();
                if (result.error) throw new Error(result.error);
                
                feedback.innerText = result.explanation; 
                feedback.className = result.is_correct ? 'feedback-box correct' : 'feedback-box incorrect';
                
            } catch (error) {
                feedback.innerText = `–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –≤–æ –≤—Ä–µ–º—è —Ä–µ–≤—å—é: ${error.message}`;
                feedback.className = 'feedback-box incorrect';
            } finally {
                checkBtn.disabled = false;
                newTaskBtn.disabled = false;
            }
        }

        newTaskBtn.addEventListener('click', fetchNewTask);
        checkBtn.addEventListener('click', checkSolution);
        document.addEventListener('DOMContentLoaded', fetchNewTask);
    </script>
</body>
</html>
