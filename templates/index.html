<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ –∫–æ–¥–∞</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>

    <div class="main-grid-container">
        <div id="history-panel" class="side-panel">
            <h2>–ò—Å—Ç–æ—Ä–∏—è</h2>
            <div id="history-items">
                <p>–ó–¥–µ—Å—å –±—É–¥–µ—Ç –≤–∞—à–∞ –∏—Å—Ç–æ—Ä–∏—è —Ä–µ—à–µ–Ω–∏–π.</p>
            </div>
        </div>

        <div class="main-content">
            <h1>–¢—Ä–µ–Ω–∞–∂–µ—Ä –ø–æ –æ—Ç–ª–∞–¥–∫–µ Python</h1>
            <div class="task-box">
                <h2 id="task-title">–ó–∞–≥—Ä—É–∑–∫–∞...</h2>
                <p id="task-description"></p>
            </div>
            <div class="code-editor">
                <textarea id="code-area" rows="18" placeholder="–ò—Å–ø—Ä–∞–≤—å—Ç–µ –∫–æ–¥ –∑–¥–µ—Å—å..."></textarea>
            </div>
            <div class="controls">
                <button id="check-btn">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å</button>
                <button id="new-task-btn">–°–ª–µ–¥—É—é—â–µ–µ –∑–∞–¥–∞–Ω–∏–µ</button>
            </div>
            <div id="feedback" class="feedback-box"></div>
        </div>

        <div id="theme-panel" class="side-panel">
            <h2>–¢–µ–º—ã –æ—à–∏–±–æ–∫</h2>
            <label for="theme-selector">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é:</label>
            <select id="theme-selector">
                <option value="–æ–±—â–∏–µ –∞–ª–≥–æ—Ä–∏—Ç–º—ã">–û–±—â–∏–µ –∞–ª–≥–æ—Ä–∏—Ç–º—ã</option>
                <option value="—Ä–∞–±–æ—Ç–∞ —Å–æ —Å–ø–∏—Å–∫–∞–º–∏">–†–∞–±–æ—Ç–∞ —Å–æ —Å–ø–∏—Å–∫–∞–º–∏</option>
                <option value="—Ä–∞–±–æ—Ç–∞ —Å–æ —Å—Ç—Ä–æ–∫–∞–º–∏">–†–∞–±–æ—Ç–∞ —Å–æ —Å—Ç—Ä–æ–∫–∞–º–∏</option>
                <option value="–ª–æ–≥–∏—á–µ—Å–∫–∏–µ –æ–ø–µ—Ä–∞—Ç–æ—Ä—ã">–õ–æ–≥–∏—á–µ—Å–∫–∏–µ –æ–ø–µ—Ä–∞—Ç–æ—Ä—ã</option>
                <option value="–æ—à–∏–±–∫–∏ –Ω–∞ –µ–¥–∏–Ω–∏—Ü—É">–û—à–∏–±–∫–∏ "–Ω–∞ –µ–¥–∏–Ω–∏—Ü—É" (Off-by-one)</option>
                <option value="—Å–ª–æ–≤–∞—Ä–∏ –∏ –º–Ω–æ–∂–µ—Å—Ç–≤–∞">–°–ª–æ–≤–∞—Ä–∏ –∏ –º–Ω–æ–∂–µ—Å—Ç–≤–∞</option>
                <option value="—Ä–µ–∫—É—Ä—Å–∏—è">–†–µ–∫—É—Ä—Å–∏—è</option>
            </select>
        </div>
    </div>

    <script>
        const taskTitle = document.getElementById('task-title');
        const taskDescription = document.getElementById('task-description');
        const codeArea = document.getElementById('code-area');
        const checkBtn = document.getElementById('check-btn');
        const newTaskBtn = document.getElementById('new-task-btn');
        const feedback = document.getElementById('feedback');
        const themeSelector = document.getElementById('theme-selector');
        const historyItems = document.getElementById('history-items');

        let currentTask = {};
        let taskHistory = [];
        let isCurrentTaskAttempted = false;

        function renderHistory() {
            historyItems.innerHTML = '';
            if (taskHistory.length === 0) {
                historyItems.innerHTML = '<p>–ó–¥–µ—Å—å –±—É–¥–µ—Ç –≤–∞—à–∞ –∏—Å—Ç–æ—Ä–∏—è —Ä–µ—à–µ–Ω–∏–π.</p>';
                return;
            }
            taskHistory.forEach((isCorrect, index) => {
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item';
                
                const circle = document.createElement('div');
                circle.className = `history-circle ${isCorrect ? 'correct' : 'incorrect'}`;
                circle.textContent = index + 1;

                const text = document.createElement('span');
                text.textContent = `–ó–∞–¥–∞–Ω–∏–µ #${index + 1}: ${isCorrect ? '–†–µ—à–µ–Ω–æ' : '–û—à–∏–±–∫–∞'}`;

                historyItem.appendChild(circle);
                historyItem.appendChild(text);
                historyItems.appendChild(historyItem);
            });
        }

        async function fetchNewTask() {
            isCurrentTaskAttempted = false;

            feedback.style.display = 'none';
            taskTitle.textContent = 'üß† –ì–µ–Ω–µ—Ä–∏—Ä—É—é –Ω–æ–≤—É—é –∑–∞–¥–∞—á—É...';
            taskDescription.textContent = '';
            codeArea.value = '';
            checkBtn.disabled = true;
            newTaskBtn.disabled = true;

            const selectedTheme = themeSelector.value;

            try {
                const response = await fetch(`/get-task?theme=${encodeURIComponent(selectedTheme)}`, { cache: 'no-cache' });
                if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –∏–ª–∏ —Å–µ—Ä–≤–µ—Ä–∞.');
                
                const task = await response.json();
                if (task.error) throw new Error(task.error);

                currentTask = task;
                taskTitle.textContent = task.title;
                taskDescription.textContent = task.task;
                codeArea.value = task.buggy_code;
                
            } catch (error) {
                taskTitle.textContent = '–û—à–∏–±–∫–∞!';
                taskDescription.textContent = `–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∑–∞–¥–∞—á—É. ${error.message}`;
            } finally {
                checkBtn.disabled = false;
                newTaskBtn.disabled = false;
            }
        }

        async function checkSolution() {
            if (!currentTask.task) return;

            const userCode = codeArea.value;
            feedback.style.display = 'block';
            feedback.className = 'feedback-box';
            feedback.textContent = '–û—Ç–ø—Ä–∞–≤–∏–ª –≤–∞—à –∫–æ–¥ –Ω–∞ —Ä–µ–≤—å—é –∫ –ò–ò...';
            checkBtn.disabled = true;

            try {
                const response = await fetch('/check-solution-with-llm', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code: userCode, task: currentTask.task })
                });

                const result = await response.json();
                if (result.error) throw new Error(result.error);
                
                feedback.innerText = result.explanation; 
                feedback.className = `feedback-box ${result.is_correct ? 'correct' : 'incorrect'}`;
                
                if (isCurrentTaskAttempted) {
                    taskHistory[taskHistory.length - 1] = result.is_correct;
                } else {
                    taskHistory.push(result.is_correct);
                    isCurrentTaskAttempted = true;
                }
                renderHistory();
                
            } catch (error) {
                feedback.innerText = `–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –≤–æ –≤—Ä–µ–º—è —Ä–µ–≤—å—é: ${error.message}`;
                feedback.className = 'feedback-box incorrect';
            } finally {
                checkBtn.disabled = false;
            }
        }

        newTaskBtn.addEventListener('click', fetchNewTask);
        themeSelector.addEventListener('change', fetchNewTask);
        checkBtn.addEventListener('click', checkSolution);
        document.addEventListener('DOMContentLoaded', () => {
            renderHistory();
            fetchNewTask();
        });
    </script>
</body>
</html>
