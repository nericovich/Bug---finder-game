<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢—Ä–µ–Ω–∞–∂–µ—Ä –ø–æ –æ—Ç–ª–∞–¥–∫–µ Python</title>
    <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —Å—Ç–∏–ª–µ–π CodeMirror -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/material-darker.min.css">
    
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">

    <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —Å–∫—Ä–∏–ø—Ç–æ–≤ CodeMirror -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/python/python.min.js"></script>
</head>
<body>

    <div class="page-container">
        <!-- –õ–µ–≤–∞—è –±–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å -->
        <aside class="sidebar left-sidebar">
            <div class="sidebar-header">
                <a href="/" class="logo">
                    <svg width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M10 9L14 4H18L22 9L18 14H14L10 9Z" fill="#FFDE40"></path><path d="M4 15L9 10H13L18 15L13 20H9L4 15Z" fill="#40A0FF"></path><path d="M16 22L21 17H25L30 22L25 27H21L16 22Z" fill="#FF4040"></path></svg>
                    <span>Python Debugger</span>
                </a>
            </div>
            <nav class="sidebar-nav">
                <div id="theme-container"></div>
            </nav>
        </aside>

        <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
        <main class="main-content">
            <header class="main-header">
                <h1 id="task-title">–ó–∞–≥—Ä—É–∑–∫–∞...</h1>
            </header>
            
            <article class="task-article">
                <section class="task-section">
                    <h3>–£—Å–ª–æ–≤–∏–µ –∑–∞–¥–∞—á–∏</h3>
                    <p id="task-description"></p>
                </section>

                <section class="task-section">
                    <h3>–ö–æ–¥ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏</h3>
                    <div id="code-editor-container"></div>
                </section>
                
                <div id="feedback" class="feedback-box"></div>

                <footer class="task-footer">
                    <button id="check-btn" class="button-primary">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å</button>
                    <button id="new-task-btn" class="button-secondary">–°–ª–µ–¥—É—é—â–µ–µ –∑–∞–¥–∞–Ω–∏–µ</button>
                </footer>
            </article>
        </main>
        
        <!-- –ü—Ä–∞–≤–∞—è –±–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å -->
        <aside class="sidebar right-sidebar">
            <nav class="sidebar-nav">
                 <div class="nav-section">
                    <h2 class="nav-title">–ò—Å—Ç–æ—Ä–∏—è –∑–∞–¥–∞–Ω–∏–π</h2>
                    <div id="history-items">
                        <p class="placeholder">–ó–¥–µ—Å—å –±—É–¥–µ—Ç –≤–∞—à–∞ –∏—Å—Ç–æ—Ä–∏—è —Ä–µ—à–µ–Ω–∏–π.</p>
                    </div>
                </div>
            </nav>
        </aside>
    </div>

    <script>
        // --- –≠–ª–µ–º–µ–Ω—Ç—ã DOM ---
        const taskTitle = document.getElementById('task-title');
        const taskDescription = document.getElementById('task-description');
        const checkBtn = document.getElementById('check-btn');
        const newTaskBtn = document.getElementById('new-task-btn');
        const feedback = document.getElementById('feedback');
        const themeContainer = document.getElementById('theme-container');
        const historyItems = document.getElementById('history-items');

        // --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ CodeMirror ---
        let editor;

        // --- –°–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è ---
        let currentTask = {};
        // –ò–ó–ú–ï–ù–ï–ù–ò–ï: –¢–µ–ø–µ—Ä—å —Ö—Ä–∞–Ω–∏–º –ø–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –æ –∑–∞–¥–∞—á–µ –≤ –∏—Å—Ç–æ—Ä–∏–∏
        let taskHistory = []; 
        let isCurrentTaskAttempted = false;
        let activeTaskIndex = -1; // –ò–Ω–¥–µ–∫—Å —Ç–µ–∫—É—â–µ–≥–æ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –∑–∞–¥–∞–Ω–∏—è

        const themeSections = [
            {
                title: "–ë–∞–∑–æ–≤—ã–µ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ Python",
                subtopics: [
                    { id: '–≤–≤–æ–¥ –∏ –≤—ã–≤–æ–¥ –¥–∞–Ω–Ω—ã—Ö, –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å —á–∏—Å–ª–∞–º–∏ –∏ —Å—Ç—Ä–æ–∫–∞–º–∏, —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ', name: '–í–≤–æ–¥ –∏ –≤—ã–≤–æ–¥ –¥–∞–Ω–Ω—ã—Ö. –û–ø–µ—Ä–∞—Ü–∏–∏ —Å —á–∏—Å–ª–∞–º–∏, —Å—Ç—Ä–æ–∫–∞–º–∏. –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ' },
                    { id: '—É—Å–ª–æ–≤–Ω—ã–π –æ–ø–µ—Ä–∞—Ç–æ—Ä', name: '–£—Å–ª–æ–≤–Ω—ã–π –æ–ø–µ—Ä–∞—Ç–æ—Ä' },
                    { id: '—Ü–∏–∫–ª—ã', name: '–¶–∏–∫–ª—ã' },
                    { id: '–≤–ª–æ–∂–µ–Ω–Ω—ã–µ —Ü–∏–∫–ª—ã', name: '–í–ª–æ–∂–µ–Ω–Ω—ã–µ —Ü–∏–∫–ª—ã' },
                ]
            },
            {
                title: "–ö–æ–ª–ª–µ–∫—Ü–∏–∏ –∏ —Ä–∞–±–æ—Ç–∞ —Å –ø–∞–º—è—Ç—å—é",
                subtopics: [
                    { id: '—Å—Ç—Ä–æ–∫–∏, –∫–æ—Ä—Ç–µ–∂–∏, —Å–ø–∏—Å–∫–∏', name: '–°—Ç—Ä–æ–∫–∏, –∫–æ—Ä—Ç–µ–∂–∏, —Å–ø–∏—Å–∫–∏' },
                    { id: '–º–Ω–æ–∂–µ—Å—Ç–≤–∞, —Å–ª–æ–≤–∞—Ä–∏', name: '–ú–Ω–æ–∂–µ—Å—Ç–≤–∞, —Å–ª–æ–≤–∞—Ä–∏' },
                    { id: '—Å–ø–∏—Å–æ—á–Ω—ã–µ –≤—ã—Ä–∞–∂–µ–Ω–∏—è –∏ –º–æ–¥–µ–ª—å –ø–∞–º—è—Ç–∏', name: '–°–ø–∏—Å–æ—á–Ω—ã–µ –≤—ã—Ä–∞–∂–µ–Ω–∏—è. –ú–æ–¥–µ–ª—å –ø–∞–º—è—Ç–∏' },
                    { id: '–≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –∫–æ–ª–ª–µ–∫—Ü–∏–π', name: '–í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –ø–æ —Ä–∞–±–æ—Ç–µ —Å –∫–æ–ª–ª–µ–∫—Ü–∏—è–º–∏' },
                    { id: '—Ä–∞–±–æ—Ç–∞ —Å —Ñ–∞–π–ª–∞–º–∏ –∏ json', name: '–ü–æ—Ç–æ–∫–æ–≤—ã–π –≤–≤–æ–¥/–≤—ã–≤–æ–¥. –†–∞–±–æ—Ç–∞ —Å —Ñ–∞–π–ª–∞–º–∏. JSON' },
                ]
            },
            {
                title: "–§—É–Ω–∫—Ü–∏–∏ –∏ –∏—Ö –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏",
                subtopics: [
                    { id: '—Ñ—É–Ω–∫—Ü–∏–∏, –æ–±–ª–∞—Å—Ç–∏ –≤–∏–¥–∏–º–æ—Å—Ç–∏, –ø–µ—Ä–µ–¥–∞—á–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤', name: '–§—É–Ω–∫—Ü–∏–∏. –û–±–ª–∞—Å—Ç–∏ –≤–∏–¥–∏–º–æ—Å—Ç–∏. –ü–µ—Ä–µ–¥–∞—á–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤' },
                    { id: '–ø–æ–∑–∏—Ü–∏–æ–Ω–Ω—ã–µ –∏ –∏–º–µ–Ω–æ–≤–∞–Ω–Ω—ã–µ –∞—Ä–≥—É–º–µ–Ω—Ç—ã, —Ñ—É–Ω–∫—Ü–∏–∏ –≤—ã—Å—à–∏—Ö –ø–æ—Ä—è–¥–∫–æ–≤, –ª—è–º–±–¥–∞-—Ñ—É–Ω–∫—Ü–∏–∏', name: '–ü–æ–∑–∏—Ü–∏–æ–Ω–Ω—ã–µ –∏ –∏–º–µ–Ω–æ–≤–∞–Ω–Ω—ã–µ –∞—Ä–≥—É–º–µ–Ω—Ç—ã. –õ—è–º–±–¥–∞-—Ñ—É–Ω–∫—Ü–∏–∏' },
                    { id: '—Ä–µ–∫—É—Ä—Å–∏—è, –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä—ã, –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä—ã', name: '–†–µ–∫—É—Ä—Å–∏—è. –î–µ–∫–æ—Ä–∞—Ç–æ—Ä—ã. –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä—ã' },
                ]
            },
            {
                title: "–û–±—ä–µ–∫—Ç–Ω–æ-–æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ",
                subtopics: [
                    { id: '–∫–ª–∞—Å—Å—ã, –ø–æ–ª—è –∏ –º–µ—Ç–æ–¥—ã', name: '–û–±—ä–µ–∫—Ç–Ω–∞—è –º–æ–¥–µ–ª—å Python. –ö–ª–∞—Å—Å—ã, –ø–æ–ª—è –∏ –º–µ—Ç–æ–¥—ã' },
                    { id: '–≤–æ–ª—à–µ–±–Ω—ã–µ –º–µ—Ç–æ–¥—ã –∏ –Ω–∞—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ', name: '–í–æ–ª—à–µ–±–Ω—ã–µ –º–µ—Ç–æ–¥—ã, –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –º–µ—Ç–æ–¥–æ–≤. –ù–∞—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ' },
                    { id: '–æ–±—Ä–∞–±–æ—Ç–∫–∞ –∏—Å–∫–ª—é—á–µ–Ω–∏–π –∏ –º–æ–¥—É–ª–∏', name: '–ú–æ–¥–µ–ª—å –∏—Å–∫–ª—é—á–µ–Ω–∏–π Python. Try, except. –ú–æ–¥—É–ª–∏' },
                ]
            },
            {
                title: "–ë–∏–±–ª–∏–æ—Ç–µ–∫–∏ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö",
                subtopics: [
                    { id: '–º–æ–¥—É–ª–∏ math –∏ numpy', name: '–ú–æ–¥—É–ª–∏ math –∏ numpy' },
                    { id: '–º–æ–¥—É–ª—å pandas', name: '–ú–æ–¥—É–ª—å pandas' },
                    { id: '–º–æ–¥—É–ª—å requests', name: '–ú–æ–¥—É–ª—å requests' },
                ]
            }
        ];
        let currentTheme = themeSections[0].subtopics[0].id;

        // --- –§—É–Ω–∫—Ü–∏–∏ ---
        
        function renderThemes() {
            themeContainer.innerHTML = '';
            themeSections.forEach(section => {
                const sectionDiv = document.createElement('div');
                sectionDiv.className = 'nav-section';
                const titleH2 = document.createElement('h2');
                titleH2.className = 'nav-title';
                titleH2.textContent = section.title;
                sectionDiv.appendChild(titleH2);
                const listDiv = document.createElement('div');
                listDiv.className = 'theme-list';
                section.subtopics.forEach(theme => {
                    const themeItem = document.createElement('a');
                    themeItem.className = 'theme-item';
                    themeItem.textContent = theme.name;
                    themeItem.dataset.themeId = theme.id;
                    if (theme.id === currentTheme) {
                        themeItem.classList.add('active');
                    }
                    listDiv.appendChild(themeItem);
                });
                sectionDiv.appendChild(listDiv);
                themeContainer.appendChild(sectionDiv);
            });
        }

        function renderHistory() {
            historyItems.innerHTML = '';
            if (taskHistory.length === 0) {
                historyItems.innerHTML = '<p class="placeholder">–ó–¥–µ—Å—å –±—É–¥–µ—Ç –≤–∞—à–∞ –∏—Å—Ç–æ—Ä–∏—è —Ä–µ—à–µ–Ω–∏–π.</p>';
                return;
            }
            taskHistory.forEach((historyEntry, index) => {
                const lessonDiv = document.createElement('div');
                lessonDiv.className = `history-lesson ${historyEntry.isCorrect ? 'correct' : 'incorrect'}`;
                lessonDiv.dataset.taskIndex = index; // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω–¥–µ–∫—Å –¥–ª—è –∫–ª–∏–∫–∞
                if (index === activeTaskIndex) {
                    lessonDiv.classList.add('active');
                }
                
                const titleSpan = document.createElement('span');
                titleSpan.className = 'lesson-title';
                titleSpan.textContent = `–ó–∞–¥–∞–Ω–∏–µ #${index + 1}`;

                const statusSpan = document.createElement('span');
                statusSpan.className = 'lesson-status';
                statusSpan.textContent = historyEntry.isCorrect ? '–†–µ—à–µ–Ω–æ' : '–û—à–∏–±–∫–∞';
                
                lessonDiv.appendChild(titleSpan);
                lessonDiv.appendChild(statusSpan);
                historyItems.appendChild(lessonDiv);
            });
        }
        
        // –ò–ó–ú–ï–ù–ï–ù–ò–ï: –ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∑–∞–¥–∞—á–∏ –ø–æ –∏–Ω–¥–µ–∫—Å—É
        function displayTask(index) {
            const historyEntry = taskHistory[index];
            if (!historyEntry) return;

            currentTask = historyEntry.taskData;
            activeTaskIndex = index;

            taskTitle.textContent = currentTask.title;
            taskDescription.textContent = currentTask.task;
            editor.setValue(currentTask.buggy_code || '');
            
            // –ï—Å–ª–∏ –º—ã –ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞–µ–º —Å—Ç–∞—Ä–æ–µ –∑–∞–¥–∞–Ω–∏–µ, –±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –ø—Ä–æ–≤–µ—Ä–∫–∏
            const isViewingOldTask = index < taskHistory.length - 1 || isCurrentTaskAttempted;
            checkBtn.disabled = isViewingOldTask;
            feedback.style.display = 'none';

            renderHistory(); // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é, —á—Ç–æ–±—ã –ø–æ–¥—Å–≤–µ—Ç–∏—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç
        }

        async function fetchNewTask() {
            isCurrentTaskAttempted = false;
            feedback.style.display = 'none';
            taskTitle.textContent = 'üß† –ì–µ–Ω–µ—Ä–∏—Ä—É—é –Ω–æ–≤—É—é –∑–∞–¥–∞—á—É...';
            taskDescription.textContent = '';
            editor.setValue('');
            checkBtn.disabled = true;
            newTaskBtn.disabled = true;

            try {
                const response = await fetch(`/get-task?theme=${encodeURIComponent(currentTheme)}`, { cache: 'no-cache' });
                if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –∏–ª–∏ —Å–µ—Ä–≤–µ—Ä–∞.');
                
                const task = await response.json();
                if (task.error) throw new Error(task.error);

                // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ –∑–∞–¥–∞–Ω–∏–µ –≤ –∏—Å—Ç–æ—Ä–∏—é, –Ω–æ –ø–æ–∫–∞ –±–µ–∑ —Å—Ç–∞—Ç—É—Å–∞ —Ä–µ—à–µ–Ω–∏—è
                taskHistory.push({ taskData: task, isCorrect: false });
                displayTask(taskHistory.length - 1); // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –Ω–æ–≤–æ–µ –∑–∞–¥–∞–Ω–∏–µ
                
            } catch (error) {
                taskTitle.textContent = '–û—à–∏–±–∫–∞!';
                taskDescription.textContent = `–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∑–∞–¥–∞—á—É. ${error.message}`;
            } finally {
                checkBtn.disabled = false;
                newTaskBtn.disabled = false;
            }
        }

        async function checkSolution() {
            if (!currentTask.task) return;

            const userCode = editor.getValue();
            feedback.style.display = 'block';
            feedback.className = 'feedback-box';
            feedback.textContent = '–û—Ç–ø—Ä–∞–≤–∏–ª –≤–∞—à –∫–æ–¥ –Ω–∞ —Ä–µ–≤—å—é –∫ –ò–ò...';
            checkBtn.disabled = true;

            try {
                const response = await fetch('/check-solution-with-llm', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code: userCode, task: currentTask.task })
                });

                const result = await response.json();
                if (result.error) throw new Error(result.error);
                
                feedback.innerText = result.explanation; 
                feedback.className = `feedback-box ${result.is_correct ? 'correct' : 'incorrect'}`;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å —Ç–µ–∫—É—â–µ–≥–æ –∑–∞–¥–∞–Ω–∏—è –≤ –∏—Å—Ç–æ—Ä–∏–∏
                taskHistory[activeTaskIndex].isCorrect = result.is_correct;
                isCurrentTaskAttempted = true;
                checkBtn.disabled = true; // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–π –ø–æ–ø—ã—Ç–∫–∏
                renderHistory();
                
            } catch (error) {
                feedback.innerText = `–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –≤–æ –≤—Ä–µ–º—è —Ä–µ–≤—å—é: ${error.message}`;
                feedback.className = 'feedback-box incorrect';
                checkBtn.disabled = false; // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏
            }
        }

        // --- –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π ---
        document.addEventListener('DOMContentLoaded', () => {
            editor = CodeMirror(document.getElementById('code-editor-container'), {
                mode: 'python',
                theme: 'material-darker',
                lineNumbers: true,
                tabSize: 4,
                indentUnit: 4,
                indentWithTabs: false
            });

            renderHistory();
            renderThemes();
            fetchNewTask();
        });

        newTaskBtn.addEventListener('click', fetchNewTask);
        themeContainer.addEventListener('click', (event) => {
            const clickedItem = event.target.closest('.theme-item');
            if (clickedItem && !clickedItem.classList.contains('active')) {
                currentTheme = clickedItem.dataset.themeId;
                taskHistory = []; // –û—á–∏—â–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –ø—Ä–∏ —Å–º–µ–Ω–µ —Ç–µ–º—ã
                renderThemes();
                fetchNewTask();
            }
        });
        checkBtn.addEventListener('click', checkSolution);

        // –ò–ó–ú–ï–ù–ï–ù–ò–ï: –ù–æ–≤—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–ª–∏–∫–æ–≤ –ø–æ –∏—Å—Ç–æ—Ä–∏–∏
        historyItems.addEventListener('click', (event) => {
            const clickedItem = event.target.closest('.history-lesson');
            if (clickedItem) {
                const index = parseInt(clickedItem.dataset.taskIndex, 10);
                displayTask(index);
            }
        });
    </script>
</body>
</html>
